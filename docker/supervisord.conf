[supervisord]
nodaemon=true
user=root
logfile=/var/log/supervisor/supervisord.log
pidfile=/var/run/supervisord.pid
childlogdir=/var/log/supervisor
logfile_maxbytes=50MB
logfile_backups=10
loglevel=info

[unix_http_server]
file=/var/run/supervisor.sock
chmod=0700

[supervisorctl]
serverurl=unix:///var/run/supervisor.sock

[rpcinterface:supervisor]
supervisor.rpcinterface_factory = supervisor.rpcinterface:make_main_rpcinterface

# Django application with Gunicorn
[program:django]
command=gunicorn muntazir_portfolio.wsgi:application --bind 0.0.0.0:8000 --workers 3 --worker-class gevent --worker-connections 1000 --max-requests 1000 --max-requests-jitter 100 --timeout 30 --keep-alive 2 --preload
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/django.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/app/logs/django_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
environment=DJANGO_SETTINGS_MODULE="muntazir_portfolio.settings.prod"
stopsignal=TERM
killasgroup=true
stopasgroup=true
priority=100

# Nginx web server
[program:nginx]
command=nginx -g "daemon off;"
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/nginx.log
stdout_logfile_maxbytes=50MB
stdout_logfile_backups=10
stderr_logfile=/var/log/supervisor/nginx_error.log
stderr_logfile_maxbytes=50MB
stderr_logfile_backups=10
stopsignal=QUIT
killasgroup=true
stopasgroup=true
priority=200

# Log rotation
[program:logrotate]
command=/usr/sbin/logrotate -f /etc/logrotate.conf
autostart=false
autorestart=false
redirect_stderr=true
stdout_logfile=/var/log/supervisor/logrotate.log
stderr_logfile=/var/log/supervisor/logrotate_error.log
stopsignal=TERM
priority=300

# Cron for scheduled tasks
[program:cron]
command=cron -f
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/var/log/supervisor/cron.log
stderr_logfile=/var/log/supervisor/cron_error.log
stopsignal=TERM
priority=400

# Django management commands runner
[program:django-management]
command=/app/docker/management-runner.sh
directory=/app
user=root
autostart=false
autorestart=false
redirect_stderr=true
stdout_logfile=/app/logs/management.log
stderr_logfile=/app/logs/management_error.log
environment=DJANGO_SETTINGS_MODULE="muntazir_portfolio.settings.prod"
stopsignal=TERM
priority=500

# Health check service
[program:healthcheck]
command=/app/docker/healthcheck.sh
directory=/app
user=root
autostart=true
autorestart=true
redirect_stderr=true
stdout_logfile=/app/logs/healthcheck.log
stderr_logfile=/app/logs/healthcheck_error.log
stopsignal=TERM
priority=600

# File cleanup service
[program:cleanup]
command=/app/docker/cleanup.sh
directory=/app
user=root
autostart=false
autorestart=false
redirect_stderr=true
stdout_logfile=/app/logs/cleanup.log
stderr_logfile=/app/logs/cleanup_error.log
stopsignal=TERM
priority=700

# Log monitoring
[program:log-monitor]
command=tail -f /app/logs/django.log /app/logs/django_error.log /var/log/nginx/access.log /var/log/nginx/error.log
autostart=false
autorestart=true
redirect_stderr=true
stdout_logfile=/dev/stdout
stdout_logfile_maxbytes=0
stderr_logfile=/dev/stderr
stderr_logfile_maxbytes=0
stopsignal=TERM
priority=800

# Group configurations
[group:web]
programs=django,nginx
priority=100

[group:maintenance]
programs=logrotate,cleanup
priority=200

[group:monitoring]
programs=healthcheck,log-monitor
priority=300

# Event listeners
[eventlistener:memmon]
command=memmon -a 200MB -m admin@muntazir.com
events=PROCESS_STATE_RUNNING
buffer_size=10

[eventlistener:crashmail]
command=crashmail -a -m admin@muntazir.com
events=PROCESS_STATE_EXITED
buffer_size=10

# Include additional configurations
[include]
files = /etc/supervisor/conf.d/*.conf